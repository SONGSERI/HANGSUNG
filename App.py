import streamlit as st
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import matplotlib.font_manager as fm
import matplotlib

FONT_PATH = os.path.join(os.path.dirname(__file__), "fonts", "NanumGothic.ttf")

font_prop = fm.FontProperties(fname=FONT_PATH)
matplotlib.rcParams["font.family"] = font_prop.get_name()
matplotlib.rcParams["axes.unicode_minus"] = False

# ============================================================
# Page Config
# ============================================================
st.set_page_config(page_title="SMT ì„¤ë¹„ ì •ì§€ ìš´ì˜ ë¶„ì„", layout="wide")

# ============================================================
# Demo ë°ì´í„° (ê³ ê° DB ê°€ì •)
# ============================================================
np.random.seed(42)
df = pd.DataFrame({
    "ì„¤ë¹„": [f"M{i}" for i in range(1, 9)],
    "ë¼ì¸": ["L1"] * 8,
    "CPErr": np.random.randint(3, 30, 8),
    "CRErr": np.random.randint(2, 20, 8),
    "CPErrStop": np.random.randint(300, 2500, 8),
    "CRErrStop": np.random.randint(200, 2000, 8),
    "PRDStop": np.random.randint(500, 5000, 8),
    "AlarmCnt": np.random.randint(20, 200, 8),
    "Prod": np.random.randint(20000, 45000, 8),
})

# ============================================================
# KPI ê³„ì‚° (Single Source of Truth)
# ============================================================
df["ì´ ì •ì§€ ì‹œê°„"] = df["CPErrStop"] + df["CRErrStop"] + df["PRDStop"]
df["ì •ì§€ íšŸìˆ˜"] = df["CPErr"] + df["CRErr"]
df["í‰ê·  ì •ì§€ ì‹œê°„"] = df["ì´ ì •ì§€ ì‹œê°„"] / df["ì •ì§€ íšŸìˆ˜"]

df["Z"] = (df["ì´ ì •ì§€ ì‹œê°„"] - df["ì´ ì •ì§€ ì‹œê°„"].mean()) / df["ì´ ì •ì§€ ì‹œê°„"].std()
df["ADI"] = df["AlarmCnt"] / df["Prod"]
df["PRDI"] = (df["ì •ì§€ íšŸìˆ˜"] * df["í‰ê·  ì •ì§€ ì‹œê°„"]) / df["Prod"]
df["NRSR"] = (df["CPErrStop"] + df["CRErrStop"]) / df["ì´ ì •ì§€ ì‹œê°„"]
df["SSI"] = df["í‰ê·  ì •ì§€ ì‹œê°„"] / df["Prod"]

def pct(val, series):
    return int((series < val).mean() * 100)

# ============================================================
# Sidebar â€“ ê²€ìƒ‰ì¡°ê±´ (ë°ì´í„° ë²”ìœ„ë§Œ)
# ============================================================
st.sidebar.title("ê²€ìƒ‰ì¡°ê±´")
ë¼ì¸ = st.sidebar.multiselect("ë¼ì¸", df["ë¼ì¸"].unique(), default=df["ë¼ì¸"].unique())
ì„¤ë¹„ = st.sidebar.multiselect("ì„¤ë¹„", df["ì„¤ë¹„"].unique(), default=df["ì„¤ë¹„"].unique())

fdf = df[df["ë¼ì¸"].isin(ë¼ì¸) & df["ì„¤ë¹„"].isin(ì„¤ë¹„)]

selected = st.sidebar.selectbox("ì„¤ë¹„ ì„ íƒ (Drill-down)", fdf["ì„¤ë¹„"])
sel = fdf[fdf["ì„¤ë¹„"] == selected].iloc[0]

# ============================================================
# Title
# ============================================================
st.title("SMT ì„¤ë¹„ ì •ì§€ ë°ì´í„° ê¸°ë°˜ ìš´ì˜ ë¶„ì„")
st.caption("ì •ì§€ ë°ì´í„°ë¥¼ KPIë¡œ êµ¬ì¡°í™”í•˜ì—¬ Â· íŒë‹¨ Â· ëŒ€ì‘ê¹Œì§€ ì—°ê²°")

# ============================================================
# KPI ì„¤ëª… íŒ¨ë„ (ì ‘ê¸°/í¼ì¹˜ê¸°)
# ============================================================
with st.expander("ğŸ“Œ KPI ì„¤ëª… ë° ì‚°ì¶œ ê·¼ê±°", expanded=False):
    st.markdown("""
ë³¸ ë¶„ì„ì€ ì •ì§€ ë°ì´í„°ë¥¼ ë‹¨ìˆœ ì§‘ê³„í•˜ì§€ ì•Šê³   
**ì„¤ë¹„ ê´€ë¦¬ íŒë‹¨ì„ ìœ„í•œ KPI ì²´ê³„**ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
""")

    st.markdown("""
### ì„¤ë¹„ ìƒíƒœ ì‹ í˜¸ KPI
**Z-score**  
- ê³„ì‚°ì‹  
  Z = (ì„¤ë¹„ ì´ ì •ì§€ ì‹œê°„ âˆ’ ì „ì²´ í‰ê· ) / í‘œì¤€í¸ì°¨  
- ì˜ë¯¸  
  í‰ê·  ëŒ€ë¹„ ì •ì§€ê°€ ìœ ë… ë§ì€ ì„¤ë¹„ë¥¼ ì„ ë³„

**ADI (Alarm Density Index)**  
- ê³„ì‚°ì‹  
  ADI = ì•ŒëŒ ë°œìƒ íšŸìˆ˜ / ìƒì‚° ì‹œê°„  
- ì˜ë¯¸  
  ë©ˆì¶”ì§€ ì•Šì•„ë„ ë‚´ë¶€ì ìœ¼ë¡œ ë¶ˆì•ˆì •í•œ ì„¤ë¹„ ì‹ë³„
""")

    st.markdown("""
### ìš´ì˜ ì˜í–¥ KPI
**PRDI**  
- ê³„ì‚°ì‹  
  PRDI = (ì •ì§€ íšŸìˆ˜ Ã— í‰ê·  ì •ì§€ ì‹œê°„) / ìƒì‚° ì‹œê°„  
- ì˜ë¯¸  
  ì§§ì€ ì •ì§€ê°€ ë°˜ë³µë˜ì–´ ìƒì‚° ë¦¬ë“¬ì„ ë¶•ê´´ì‹œí‚¤ëŠ” ì •ë„

**NRSR**  
- ê³„ì‚°ì‹  
  NRSR = ì¥ì‹œê°„ ì •ì§€ ì‹œê°„ / ì´ ì •ì§€ ì‹œê°„  
- ì˜ë¯¸  
  í•œ ë²ˆ ë©ˆì¶”ë©´ í¬ê²Œ ê°€ëŠ” ì„¤ë¹„ ì—¬ë¶€

**SSI**  
- ê³„ì‚°ì‹  
  SSI = í‰ê·  ì •ì§€ ì‹œê°„ / ìƒì‚° ì‹œê°„  
- ì˜ë¯¸  
  ì •ì§€ 1íšŒë‹¹ ìƒì‚° ì˜í–¥ ë¯¼ê°ë„
""")

    st.markdown("""
ëª¨ë“  íŒë‹¨ì€ **ì ˆëŒ€ ê¸°ì¤€ì´ ì•„ë‹Œ ì„¤ë¹„ ê°„ ìƒëŒ€ ë¹„êµ(í¼ì„¼íƒ€ì¼)**ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
""")

# ============================================================
# â‘  ì„¤ë¹„ ì´ìƒ íƒìƒ‰
# ============================================================
st.header("â‘  ì„¤ë¹„ ì´ìƒ íƒìƒ‰ â€“ ì–´ë””ë¥¼ ë¨¼ì € ë³¼ ê²ƒì¸ê°€")

fig1, ax1 = plt.subplots()
ax1.bar(fdf["ì„¤ë¹„"], fdf["Z"])
ax1.axhline(0, linestyle="--")
ax1.set_ylabel("Z-score")
st.pyplot(fig1)

st.markdown("""
í‰ê·  ëŒ€ë¹„ ì •ì§€ê°€ ë§ì€ ì„¤ë¹„ ë˜ëŠ”  
ì•ŒëŒ ë°€ë„ê°€ ë†’ì€ ì„¤ë¹„ë¥¼ ìš°ì„  í™•ì¸ ëŒ€ìƒìœ¼ë¡œ ì„ ì •í•©ë‹ˆë‹¤.
""")

# ============================================================
# â‘¡ ì •ì§€ ì„±ê²© ë¶„ì„
# ============================================================
st.header("â‘¡ ì •ì§€ ì„±ê²© ë¶„ì„ â€“ ìì£¼ vs ì˜¤ë˜")

fig2, ax2 = plt.subplots()
ax2.scatter(fdf["PRDI"], fdf["SSI"], s=120)
ax2.set_xlabel("PRDI (ë¦¬ë“¬ ë¶•ê´´)")
ax2.set_ylabel("SSI (ì •ì§€ ë¯¼ê°ë„)")
st.pyplot(fig2)

st.markdown("""
ì •ì§€ê°€ ë°˜ë³µí˜• ë¬¸ì œì¸ì§€,  
í•œ ë²ˆ ë°œìƒ ì‹œ ì¹˜ëª…ì ì¸ ë¬¸ì œì¸ì§€ êµ¬ë¶„í•©ë‹ˆë‹¤.
""")

# ============================================================
# â‘¢ ì›ì¸ êµ¬ì¡° ë¶„ì„
# ============================================================
st.header("â‘¢ ì›ì¸ êµ¬ì¡° ë¶„ì„ â€“ ì™œ ì´ëŸ° KPIê°€ ë‚˜ì™”ëŠ”ê°€")

fig3, ax3 = plt.subplots()
ax3.pie(
    [sel["CPErrStop"], sel["CRErrStop"], sel["PRDStop"]],
    labels=["Pickup", "Recognition", "Production"],
    autopct="%1.1f%%"
)
ax3.set_title(f"{selected} ì •ì§€ ì‚¬ìœ  êµ¬ì„±")
st.pyplot(fig3)

# ============================================================
# â‘£ ìš´ì˜ ì˜í–¥ í‰ê°€
# ============================================================
st.header("â‘£ ìš´ì˜ ì˜í–¥ í‰ê°€ â€“ ì–¼ë§ˆë‚˜ ìœ„í—˜í•œê°€")

c1, c2, c3 = st.columns(3)
c1.metric("PRDI", f"{sel['PRDI']:.3f}", f"ìƒìœ„ {pct(sel['PRDI'], fdf['PRDI'])}%")
c2.metric("NRSR", f"{sel['NRSR']:.1%}")
c3.metric("SSI", f"{sel['SSI']:.4f}", f"ìƒìœ„ {pct(sel['SSI'], fdf['SSI'])}%")

# ============================================================
# â‘¤ ì„¤ë¹„ ëª¨ë‹ˆí„°ë§ & Action
# ============================================================
st.header("â‘¤ ì„¤ë¹„ ëª¨ë‹ˆí„°ë§ ë° ê¶Œì¥ Action")

actions = []

if pct(sel["ADI"], fdf["ADI"]) > 70:
    actions.append("ì•ŒëŒ ë°€ë„ ë†’ìŒ â†’ ì„¼ì„œ/ì¡°ê±´/ì‘ì—… í‘œì¤€ ì ê²€")

if pct(sel["PRDI"], fdf["PRDI"]) > 70 and pct(sel["SSI"], fdf["SSI"]) > 70:
    actions.append("ë°˜ë³µ ì •ì§€ë¡œ ìƒì‚° ë¦¬ë“¬ ë¶•ê´´ â†’ ì‘ì—… ì¡°ê±´ ë° í”„ë¡œê·¸ë¨ íŠœë‹")

if sel["NRSR"] > 0.4:
    actions.append("ì¥ì‹œê°„ ì •ì§€ ë¹„ìœ¨ ë†’ìŒ â†’ ì˜ˆë°© ì •ë¹„ ë˜ëŠ” êµ¬ì¡° ì ê²€")

if not actions:
    actions.append("í˜„ì¬ KPI ê¸°ì¤€ íŠ¹ì´ ì‚¬í•­ ì—†ìŒ â†’ ì •ìƒ ìš´ì˜")

for i, a in enumerate(actions, 1):
    st.markdown(f"**Action {i}.** {a}")

st.success("ì •ì§€ ë°ì´í„° â†’ KPI â†’ íŒë‹¨ â†’ ëŒ€ì‘ê¹Œì§€ í•˜ë‚˜ì˜ íë¦„ìœ¼ë¡œ ì—°ê²°ë©ë‹ˆë‹¤.")
